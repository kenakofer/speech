#!/bin/bash
#
# Wrapper script for whisper-hotkey.py
# Installs required dependencies and launches the speech recognition tool

# Set the directory of this script
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Function to check and install Python packages
check_install_package() {
    local package_name="$1"
    local import_name="${2:-$1}"
    
    echo "Checking for $package_name..."
    if ! python3 -c "import $import_name" &>/dev/null; then
        echo "Installing $package_name..."
        pip install --user "$package_name"
    fi
}

# Check for required system packages
if ! command -v python3 &>/dev/null; then
    echo "Python 3 is required but not installed. Please install it."
    exit 1
fi

# Check for system dependencies
if ! command -v ffmpeg &>/dev/null || ! command -v xclip &>/dev/null || ! command -v xdotool &>/dev/null; then
    echo "Required system packages not found. Please install them with:"
    echo "sudo apt install -y ffmpeg xclip xdotool"
    exit 1
fi

# Check for and install required Python packages
check_install_package "sounddevice"
check_install_package "numpy"
check_install_package "pynput"
check_install_package "openai-whisper" "whisper"
check_install_package "soundfile" "soundfile"

# Check for faster-whisper if requested
if [[ "$*" == *"--faster"* ]]; then
    check_install_package "faster-whisper" "faster_whisper"
fi

# Launch the whisper hotkey script
python3 "$SCRIPT_DIR/whisper-hotkey.py" "$@"